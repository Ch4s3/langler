service: langler
image: ch4s3/langler

# Build on the droplet (has swap now) to avoid ARM Mac QEMU issues
builder:
  arch: amd64
  local: false
  remote: ssh://root@142.93.178.180

servers:
  web:
    - 142.93.178.180

proxy:
  ssl: true
  # Domain(s) for routing and Let's Encrypt; must resolve to this server
  hosts:
    - news-deck.com
    - app.news-deck.com
    - www.news-deck.com
  app_port: 4000
  forward_headers: true
  healthcheck:
    path: /
    interval: 3

registry:
  server: ghcr.io
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    PHX_SERVER: "true"
    PHX_HOST: news-deck.com
    PORT: "4000"
    POOL_SIZE: "5"
    RELEASE_DISTRIBUTION: "name"
    RELEASE_NODE: "langler@142.93.178.180"
  secret:
    - SECRET_KEY_BASE
    - DATABASE_URL
    - MAILGUN_API_KEY
    - MAILGUN_DOMAIN
    - MAILGUN_BASE_URL

accessories:
  db:
    image: postgres:15
    host: 142.93.178.180
    port: 5432
    env:
      clear:
        POSTGRES_USER: langler
        POSTGRES_DB: langler_prod
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
