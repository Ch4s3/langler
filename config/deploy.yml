service: langler
# Image built in GHA and pushed to GHCR. CI sets KAMAL_IMAGE to owner/repo. For local deploy (e.g. --skip-push),
# set KAMAL_IMAGE to the same value so the server pulls the image CI pushed: KAMAL_IMAGE=owner/repo kamal deploy --skip-push
image: <%= ENV["KAMAL_IMAGE"] || "ch4s3/langler" %>

# Build locally (or in GHA); image is pushed from CI, deploy uses --skip-push so droplet only pulls.
builder:
  arch: amd64
  local: true
  context: .

servers:
  web:
    - 142.93.178.180

proxy:
  ssl: true
  # Domain(s) for routing and Let's Encrypt; must resolve to this server
  hosts:
    - news-deck.com
    - app.news-deck.com
    - www.news-deck.com
  app_port: 4000
  forward_headers: true
  healthcheck:
    path: /
    interval: 3

registry:
  server: ghcr.io
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    PHX_SERVER: "true"
    PHX_HOST: news-deck.com
    PORT: "4000"
    POOL_SIZE: "15"
    RELEASE_DISTRIBUTION: "name"
    RELEASE_NODE: "langler@142.93.178.180"
    # DATABASE_URL must use host langler-db (not the server IP) so the app
    # container can reach Postgres over the Docker network, e.g.:
    # postgres://langler:YOUR_PASSWORD@langler-db:5432/langler_prod
  secret:
    - SECRET_KEY_BASE
    - DATABASE_URL
    - MAILGUN_API_KEY
    - MAILGUN_DOMAIN
    - MAILGUN_BASE_URL

accessories:
  db:
    image: postgres:15
    host: 142.93.178.180
    port: 5432
    env:
      clear:
        POSTGRES_USER: langler
        POSTGRES_DB: langler_prod
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
